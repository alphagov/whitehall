<%
  published_on ||= ""
  help_block_id = "attachment-#{attachment.id}-accessibility-help"
  help_block_toggle_id = "attachment-#{attachment.id}-accessibility-request"
  thumbnail_link_options = { "aria-hidden" => true, class: 'thumbnail', tabindex: '-1'}

  title_link_options = {}
  title_link_options['rel'] = 'external' if attachment.external?
  title_link_options["aria-describedby"] = help_block_id unless attachment.accessible?

  # This partial is rendered when sending to the publishing-api, so needs to
  # work outside of a request/controller context. The preview param, which exists
  # to bust cache and view a specific edition, isn't applicable when publishing
  # to publishing-api.
  preview = controller.nil? ? nil : params[:preview]
%>
<%= content_tag_for(:section, attachment.becomes(Attachment), class: attachment.external? ? "hosted-externally" : "embedded") do %>
  <div class="attachment-thumb">
    <% unless defined?(hide_thumbnail) && hide_thumbnail %>
      <%= link_to_unless previewable?(attachment), attachment_thumbnail(attachment), attachment.url(preview: preview), thumbnail_link_options %>
    <% end %>
  </div>
  <div class="attachment-details">
    <h2 class="title"><%= link_to_unless previewable?(attachment), attachment.title, attachment.url(preview: preview), title_link_options %></h2>
    <p class="metadata">
      <% if attachment.isbn.present? or attachment.unique_reference.present? or attachment.command_paper_number.present? or attachment.hoc_paper_number.present? %>
        <span class="references">
          <%= t('attachment.headings.reference') %>: <%= attachment_reference(attachment) %>
        </span>
      <% end %>
      <% if attachment.unnumbered_command_paper? || attachment.unnumbered_hoc_paper? %>
        <span class="unnumbered-paper">
          <% if attachment.unnumbered_command_paper? %>
            <%= t('attachment.headings.unnumbered_command_paper') %>
          <% else %>
            <%= t('attachment.headings.unnumbered_hoc_paper') %>
          <% end %>
        </span>
      <% end %>
      <% unless published_on.blank? %>
        <span class="changed"><%= t('attachment.headings.published') %>: <%= absolute_date(published_on) %></span>
      <% end %>
      <% if previewable?(attachment) %>
        <span class="preview">
          <strong>
            <%= link_to "View online", preview_path_for_attachment(attachment) %>
          </strong>
        </span>
        <span class="download">
          <%= link_to attachment.url(preview: preview) do %>
            <strong>Download <%= attachment.file_extension.upcase %></strong>
            <%= number_to_human_size(attachment.file_size) %>
          <% end %>
        </span>
      <% else %>
        <%= attachment_attributes(attachment) %>
      <% end %>
    </p>
    <% if attachment.is_official_document? %>
      <%= link_to t('attachment.headings.order_a_copy'), "#{Plek.new.website_root}/guidance/how-to-buy-printed-copies-of-official-documents",
            class: "order_url", title: t('attachment.headings.order_a_copy_full') %>
    <% end %>

    <% if attachment.opendocument? %>
      <p class="opendocument-help">
        <%= t('attachment.opendocument.help_html') %>
      </p>
    <% end %>

    <% unless attachment.accessible? %>
      <div data-module="toggle" class="accessibility-warning" id="<%= help_block_id %>">
        <p><%= t('attachment.accessibility.intro') %>
          <a class="toggler" href="#<%= help_block_toggle_id %>" data-controls="<%= help_block_toggle_id %>" data-expanded="false"><%= t('attachment.accessibility.request_a_different_format') %></a>
        </p>
        <p id="<%= help_block_toggle_id %>" class="js-hidden">
          <%= t('attachment.accessibility.full_help_html',
                email: alternative_format_order_link(attachment, alternative_format_contact_email),
                title: attachment.title,
                references: attachment_references(attachment)) %>
        </p>
      </div>
    <% end %>
  </div>
<% end %>
