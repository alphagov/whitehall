#!/usr/bin/env ruby

# This script is used during the GitHub Actions workflow
# defined in .github/workflows/cucumber.yml.
# It splits scenarios (not files) across CI matrix nodes.

node_index = ENV.fetch("CI_NODE_INDEX", "0").to_i
total_nodes = ENV.fetch("CI_NODE_TOTAL", "1").to_i

abort("CI_NODE_TOTAL must be >= 1") if total_nodes < 1
abort("CI_NODE_INDEX must be >= 0") if node_index.negative?
abort("CI_NODE_INDEX must be < CI_NODE_TOTAL") if node_index >= total_nodes

scenario_locations = Dir["features/**/*.feature"].sort.flat_map do |file|
  File.foreach(file).with_index(1).filter_map do |line, line_number|
    "#{file}:#{line_number}" if line.match?(/^\s*Scenario:/)
  end
end

tests = scenario_locations
  .select
  .with_index { |_location, i| i % total_nodes == node_index }

if tests.empty?
  warn "No scenarios assigned for this run; exiting successfully."
  exit 0
end

exec("bundle", "exec", "cucumber", *ARGV, *tests)
